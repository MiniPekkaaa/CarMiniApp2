<!DOCTYPE html>
<html>
<head>
    <title>Корзина</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 16px;
            color: var(--tg-theme-text-color, #000);
            background: var(--tg-theme-bg-color, #fff);
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: var(--tg-theme-bg-color, #fff);
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            border-radius: 8px;
        }

        .item-info {
            flex-grow: 1;
        }

        .item-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .item-price {
            color: var(--tg-theme-hint-color, #999);
            font-size: 14px;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quantity-btn {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #fff);
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .quantity-input {
            width: 40px;
            text-align: center;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            border-radius: 4px;
            padding: 4px;
        }

        .total {
            margin-top: 16px;
            font-weight: 500;
            text-align: right;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .action-btn {
            flex: 1;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #fff);
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }

        .recommendation {
            margin: 16px 0;
            padding: 12px;
            background: rgba(36, 129, 204, 0.1);
            border-radius: 8px;
            font-style: italic;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            padding: 15px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .notification.show {
            opacity: 1;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0 5px;
        }

        .empty-cart {
            text-align: center;
            margin-top: 40px;
            color: var(--tg-theme-hint-color, #999);
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="loading" class="hidden">
        Загрузка...
    </div>

    <div id="content">
        <div id="cart-items"></div>
        <div id="recommendation" class="recommendation hidden"></div>
        <div class="total">Итого: <span id="total-amount">0</span> ₽</div>
        <div class="action-buttons">
            <button class="action-btn" onclick="addMore()">Добавить ещё</button>
            <button class="action-btn" onclick="placeOrder()">Оформить заказ</button>
        </div>
    </div>

    <div id="notification" class="notification">
        <span id="notification-text"></span>
        <button class="close-btn" onclick="hideNotification()">×</button>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        
        // Получаем user_id из URL
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user_id');
        
        // Загружаем корзину при загрузке страницы
        document.addEventListener('DOMContentLoaded', loadCart);
        
        function showContent() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
        }

        function hideContent() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('content').classList.add('hidden');
        }
        
        function loadCart() {
            hideContent();
            
            // Получаем данные корзины из sessionStorage
            const cart = JSON.parse(sessionStorage.getItem('cart') || '[]');
            const cartContainer = document.getElementById('cart-items');
            cartContainer.innerHTML = '';
            
            if (cart.length === 0) {
                cartContainer.innerHTML = '<div class="empty-cart">Корзина пуста</div>';
                showContent();
                return;
            }
            
            cart.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'cart-item';
                itemElement.innerHTML = `
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-price">${item.price} ₽</div>
                    </div>
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="decrementQuantity(${index})">-</button>
                        <input type="number" class="quantity-input" value="${item.quantity}" 
                               onchange="updateQuantity(${index}, this.value)" min="1">
                        <button class="quantity-btn" onclick="incrementQuantity(${index})">+</button>
                    </div>
                `;
                cartContainer.appendChild(itemElement);
            });
            
            // Показываем рекомендацию, если она есть
            const recommendation = sessionStorage.getItem('recommendation');
            const recommendationElement = document.getElementById('recommendation');
            if (recommendation) {
                recommendationElement.textContent = recommendation;
                recommendationElement.classList.remove('hidden');
            } else {
                recommendationElement.classList.add('hidden');
            }
            
            updateTotal();
            showContent();
        }
        
        function updateTotal() {
            const cart = JSON.parse(sessionStorage.getItem('cart') || '[]');
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('total-amount').textContent = total;
        }
        
        function incrementQuantity(index) {
            const cart = JSON.parse(sessionStorage.getItem('cart') || '[]');
            cart[index].quantity++;
            sessionStorage.setItem('cart', JSON.stringify(cart));
            loadCart();
        }
        
        function decrementQuantity(index) {
            const cart = JSON.parse(sessionStorage.getItem('cart') || '[]');
            if (cart[index].quantity > 1) {
                cart[index].quantity--;
                sessionStorage.setItem('cart', JSON.stringify(cart));
                loadCart();
            }
        }
        
        function updateQuantity(index, value) {
            const cart = JSON.parse(sessionStorage.getItem('cart') || '[]');
            cart[index].quantity = Math.max(1, parseInt(value) || 1);
            sessionStorage.setItem('cart', JSON.stringify(cart));
            loadCart();
        }
        
        function addMore() {
            window.location.href = `/products?user_id=${userId}&show_product_selection=true`;
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            notificationText.textContent = message;
            notification.classList.add('show');
            
            // Автоматически скрыть через 15 секунд
            setTimeout(() => {
                hideNotification();
            }, 15000);
        }

        function hideNotification() {
            const notification = document.getElementById('notification');
            notification.classList.remove('show');
        }
        
        async function placeOrder() {
            hideContent();
            
            try {
                const cart = JSON.parse(sessionStorage.getItem('cart') || '[]');
                
                if (cart.length === 0) {
                    tg.showAlert('Корзина пуста');
                    showContent();
                    return;
                }
                
                const response = await fetch('/api/create-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        positions: cart.map(item => ({
                            id: item.id,
                            name: item.name,
                            quantity: item.quantity,
                            price: item.price,
                            legal_entity: item.legalEntity
                        }))
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Очищаем корзину
                    sessionStorage.removeItem('cart');
                    sessionStorage.removeItem('recommendation');
                    
                    showNotification('Заказ успешно создан');
                    loadCart();
                } else {
                    throw new Error(data.error || 'Ошибка при создании заказа');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Произошла ошибка: ' + error.message);
            } finally {
                showContent();
            }
        }
    </script>
</body>
</html> 