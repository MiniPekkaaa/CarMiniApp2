<!DOCTYPE html>
<html>
<head>
    <title>Корзина</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #5288c1;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 40px 15px 20px;
            background-color: #4CAF50;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-size: 14px;
            max-width: 90%;
            word-wrap: break-word;
        }

        .notification.show {
            opacity: 1;
        }

        .notification .close-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
        }

        .notification .close-btn:hover {
            opacity: 0.8;
        }

        .button-delete {
            background-color: #ff4444 !important;
            color: white !important;
        }

        .button-order {
            background-color: #4CAF50 !important;
            color: white !important;
        }

        .button-add-more {
            background-color: #5288c1 !important;
            color: white !important;
            margin-bottom: 10px !important;
        }
    </style>
</head>
<body>
    <!-- Уведомление -->
    <div id="notification" class="notification">
        <span id="notification-text"></span>
        <button class="close-btn" onclick="hideNotification()">×</button>
    </div>

    <!-- Экран загрузки -->
    <div id="loading" class="container" style="text-align: center; padding: 20px;">
        <div class="loader"></div>
    </div>

    <!-- Основной контент -->
    <div id="content" class="hidden">
        <div class="container">
            <div id="cart_items">
                <!-- Здесь будут отображаться товары -->
            </div>
            <div id="show_more_container" style="display: none;">
                <button onclick="toggleShowAll()" class="button" id="show_more_button">Показать все</button>
            </div>
            <div id="cart_total">
                <h3>Итого: <span id="total_amount">0</span>₽</h3>
            </div>
            <button onclick="addMore()" class="button button-add-more">Добавить ещё</button>
            <button onclick="placeOrder()" class="button button-order">Оформить заказ</button>
            <button onclick="goBack()" class="button">Назад</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        
        // Получаем user_id из URL
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user_id');
        
        let cartItems = []; // Сохраняем все позиции
        let showAll = false; // Флаг для отображения всех позиций
        
        // Функции для работы с уведомлениями
        let notificationTimeout;

        // Загрузка корзины при открытии страницы
        window.onload = function() {
            loadCart();
        };

        function loadCart() {
            fetch(`/api/get-cart-items?user_id=${userId}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Получены данные корзины:', data);
                    if (data && Array.isArray(data.items)) {
                        cartItems = data.items;
                        displayCartItems();
                        updateTotal(data.items);
                        
                        // Показываем рекомендацию, если она есть
                        const recommendation = localStorage.getItem('recommendation');
                        if (recommendation) {
                            showNotification(recommendation);
                            localStorage.removeItem('recommendation'); // Удаляем после показа
                        }
                    } else {
                        document.getElementById('cart_items').innerHTML = '<p>Корзина пуста</p>';
                        document.getElementById('total_amount').textContent = '0';
                    }
                    showContent();
                })
                .catch(error => {
                    console.error('Ошибка при загрузке корзины:', error);
                    document.getElementById('cart_items').innerHTML = '<p>Ошибка при загрузке корзины</p>';
                    showContent();
                });
        }

        function displayCartItems() {
            const cartItemsContainer = document.getElementById('cart_items');
            const showMoreContainer = document.getElementById('show_more_container');
            cartItemsContainer.innerHTML = '';
            
            if (cartItems.length === 0) {
                cartItemsContainer.innerHTML = '<p>Корзина пуста</p>';
                showMoreContainer.style.display = 'none';
                return;
            }

            // Показываем кнопку "Показать все" только если есть больше 5 позиций
            if (cartItems.length > 5) {
                showMoreContainer.style.display = 'block';
                document.getElementById('show_more_button').textContent = showAll ? 'Свернуть' : 'Показать все';
            } else {
                showMoreContainer.style.display = 'none';
            }

            // Отображаем нужное количество позиций
            const itemsToShow = showAll ? cartItems.length : Math.min(5, cartItems.length);
            
            for (let i = 0; i < itemsToShow; i++) {
                const item = cartItems[i];
                const itemElement = document.createElement('div');
                itemElement.className = 'cart-item';
                itemElement.innerHTML = `
                    <div class="cart-item-info">
                        <h3 class="cart-item-name">${item.name}</h3>
                        <div class="cart-item-details">
                            <p>Количество: ${item.count}</p>
                            <p>Цена: ${item.price}₽</p>
                            <p>Сумма: ${item.price * item.count}₽</p>
                        </div>
                    </div>
                    <div class="cart-item-controls">
                        <button onclick="editQuantity(${i})" class="button">Изменить объем</button>
                        <button onclick="removeItem(${i})" class="button button-delete">Удалить</button>
                    </div>
                `;
                cartItemsContainer.appendChild(itemElement);
            }
        }

        function toggleShowAll() {
            showAll = !showAll;
            displayCartItems();
        }

        function updateTotal(items) {
            const total = items.reduce((sum, item) => sum + (item.price * item.count), 0);
            document.getElementById('total_amount').textContent = total;
        }

        function editQuantity(index) {
            const item = cartItems[index];
            const newCount = prompt('Введите новое количество:', item.count);
            
            if (newCount !== null) {
                const count = parseInt(newCount);
                if (!isNaN(count) && count > 0) {
                    // Обновляем количество в Redis
                    fetch(`/api/update-cart-item?user_id=${userId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            id: item.id,
                            count: count
                        })
                    })
                    .then(response => response.json())
                    .then(() => {
                        loadCart(); // Перезагружаем корзину
                    })
                    .catch(error => {
                        console.error('Ошибка при обновлении количества:', error);
                        alert('Ошибка при обновлении количества');
                    });
                } else {
                    alert('Пожалуйста, введите корректное количество (больше 0)');
                }
            }
        }

        function removeItem(index) {
            const item = cartItems[index];
            // Удаляем позицию из Redis
            fetch(`/api/remove-cart-item?user_id=${userId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: item.id
                })
            })
            .then(response => response.json())
            .then(() => {
                loadCart(); // Перезагружаем корзину
            })
            .catch(error => {
                console.error('Ошибка при удалении позиции:', error);
                alert('Ошибка при удалении позиции');
            });
        }

        function addMore() {
            window.location.href = `/products?user_id=${userId}&show_product_selection=true`;
        }

        function goBack() {
            window.location.href = `/main_menu?user_id=${userId}`;
        }

        async function placeOrder() {
            if (cartItems.length === 0) {
                alert('Корзина пуста');
                return;
            }

            try {
                const formattedItems = cartItems.map(item => ({
                    id: item.id,
                    name: item.name,
                    legalEntity: item.legalEntity,
                    quantity: parseInt(item.count) // Преобразуем count в quantity
                }));

                const response = await fetch('/api/create-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        items: formattedItems
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Очищаем корзину после успешного создания заказа
                    cartItems = [];
                    await clearCart();
                    displayCartItems();
                    alert('Заказ успешно создан!');
                    window.location.href = '/main_menu?user_id=' + userId;
                } else {
                    throw new Error(result.error || 'Ошибка при создании заказа');
                }
            } catch (error) {
                console.error('Ошибка при создании заказа:', error);
                alert('Произошла ошибка при создании заказа: ' + error.message);
            }
        }

        function showContent() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').classList.remove('hidden');
        }

        async function clearCart() {
            try {
                const response = await fetch(`/api/clear-cart?user_id=${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Ошибка при очистке корзины');
                }
            } catch (error) {
                console.error('Ошибка при очистке корзины:', error);
                throw error;
            }
        }

        // Функции для работы с уведомлениями
        function showNotification(message, duration = 15000) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            
            // Очищаем предыдущий таймер, если он был
            if (notificationTimeout) {
                clearTimeout(notificationTimeout);
            }
            
            notificationText.textContent = message;
            notification.classList.add('show');
            
            // Устанавливаем новый таймер
            notificationTimeout = setTimeout(() => {
                hideNotification();
            }, duration);
        }

        function hideNotification() {
            const notification = document.getElementById('notification');
            notification.classList.remove('show');
            
            // Очищаем таймер при ручном закрытии
            if (notificationTimeout) {
                clearTimeout(notificationTimeout);
            }
        }
    </script>
</body>
</html> 