<!DOCTYPE html>
<html>
<head>
    <title>Ввод остатков</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <h1 class="title">Введите остатки</h1>
        <div id="products">
            {% for product in products %}
            <div class="cart-item">
                <div class="cart-item-info">
                    <h3 class="cart-item-name">{{ product.Beer_Name }}</h3>
                    <div class="quantity-controls">
                        <button onclick="decrementQuantity('{{ product.Beer_ID }}')" class="button">-</button>
                        <input type="number" id="quantity_{{ product.Beer_ID }}" value="0" min="0" class="quantity-input">
                        <button onclick="incrementQuantity('{{ product.Beer_ID }}')" class="button">+</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <button onclick="analyzeRemaining()" class="button">Анализировать и добавить в корзину</button>
        <button onclick="window.location.href='/order_menu?user_id={{ user_id }}'" class="button">Назад</button>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        
        const userId = tg.initDataUnsafe?.user?.id;
        
        function incrementQuantity(productId) {
            let input = document.getElementById('quantity_' + productId);
            input.value = parseInt(input.value) + 1;
        }
        
        function decrementQuantity(productId) {
            let input = document.getElementById('quantity_' + productId);
            if (parseInt(input.value) > 0) {
                input.value = parseInt(input.value) - 1;
            }
        }
        
        function analyzeRemaining() {
            // Собираем данные об остатках
            let remaining = {};
            {% for product in products %}
            remaining['{{ product.Beer_ID }}'] = document.getElementById('quantity_{{ product.Beer_ID }}').value;
            {% endfor %}
            
            // Отправляем на анализ
            fetch('/analyze_remaining', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: userId,
                    remaining: remaining
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Добавляем предложенные позиции в корзину
                    let cart = JSON.parse(sessionStorage.getItem('cart') || '[]');
                    
                    result.suggestions.forEach(item => {
                        cart.push({
                            id: item.id,
                            name: item.name,
                            legalEntity: item.legal_entity,
                            quantity: item.quantity
                        });
                    });
                    
                    sessionStorage.setItem('cart', JSON.stringify(cart));
                    
                    // Перенаправляем в корзину
                    window.location.href = `/cart?user_id=${userId}`;
                } else {
                    throw new Error(result.error || 'Ошибка при анализе остатков');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                tg.showAlert('Произошла ошибка: ' + error.message);
            });
        }
    </script>
</body>
</html> 